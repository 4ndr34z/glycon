{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header section remains the same -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-terminal me-2"></i>Terminal - {{ agent.hostname }}
            <span class="badge bg-{% if agent.status == 'online' %}success{% else %}danger{% endif %}">
                {{ agent.status|capitalize }}
            </span>
        </h2>
        <div>
            <button id="wsControl" class="btn btn-danger me-2">
                <i class="fas fa-plug me-1"></i>
                <span id="wsStatusText">Connect Terminal</span>
            </button>
            <a href="{{ url_for('agent_detail', agent_id=agent.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Agent
            </a>
        </div>
    </div>

    <!-- Terminal display section remains the same -->
    <div class="card shadow-sm">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <span>Remote Shell</span>
                <span>
                    <span class="badge bg-danger me-2" id="connection-status">Disconnected</span>
                    <span class="badge bg-dark">Agent ID: {{ agent.id|truncate(10) }}</span>
                </span>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="terminal" style="height: 500px; background-color: #1e1e1e; color: #f8f8f8; padding: 15px; overflow-y: auto; font-family: 'Courier New', monospace;"></div>
        </div>
        <div class="card-footer">
            <div class="input-group">
                <span class="input-group-text bg-dark text-white" id="dir-prompt" 
                      style="font-family: Consolas, monospace; min-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                    C:\>
                </span>
                <input type="text" class="form-control bg-dark text-white border-dark" 
                       id="command-input" placeholder="Enter command..." autocomplete="off" disabled
                       style="font-family: Consolas, monospace;">
                <button class="btn btn-primary" type="button" id="send-command" disabled>
                    <i class="fas fa-paper-plane me-1"></i>Send
                </button>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            WebSocket status: <span id="wsStatusAlert">Disconnected</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const terminal = document.getElementById('terminal');
    const commandInput = document.getElementById('command-input');
    const sendButton = document.getElementById('send-command');
    const dirPrompt = document.getElementById('dir-prompt');
    const wsControl = document.getElementById('wsControl');
    const wsStatusText = document.getElementById('wsStatusText');
    const wsStatusAlert = document.getElementById('wsStatusAlert');
    const connectionStatus = document.getElementById('connection-status');
    
    let currentDir = 'C:\\';
    let socket = null;
    let waitingForResponse = false;
    let isConnected = false;

    function connectWebSocket() {
        if (socket && socket.connected) {
            return;
        }

        socket = io('/terminal', {
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            transports: ['websocket']
        });

        socket.on('connect', function() {
            console.log('WebSocket connected');
            isConnected = true;
            updateConnectionStatus(true);
            socket.emit('join', { agent_id: '{{ agent.id }}' });
        });

        socket.on('disconnect', function() {
            console.log('WebSocket disconnected');
            isConnected = false;
            updateConnectionStatus(false);
        });

        socket.on('connect_error', function(error) {
            console.error('Connection error:', error);
            showAlert('Connection failed: ' + error.message, 'danger');
            updateConnectionStatus(false);
        });

        socket.on('terminal_output', function(data) {
            console.log('Received output:', data);
            waitingForResponse = false;
            
            if (data.current_dir) {
                currentDir = formatPathForDisplay(data.current_dir);
                updatePrompt();
            }
            
            terminal.innerHTML += `<div style="color: #00ff00;">${getPrompt()}> ${data.command}</div>`;
            
            if (data.output) {
                terminal.innerHTML += `<div style="font-family: Consolas, monospace; white-space: pre;">${data.output.replace(/\n/g, '<br>')}</div>`;
            }
            
            if (data.error) {
                terminal.innerHTML += `<div style="color: #ff0000;">${data.error.replace(/\n/g, '<br>')}</div>`;
            }
            
            terminal.scrollTop = terminal.scrollHeight;
        });
    }

    function updateConnectionStatus(connected) {
        if (connected) {
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'badge bg-success me-2';
            wsStatusText.textContent = 'Disconnect Terminal';
            wsControl.classList.remove('btn-danger');
            wsControl.classList.add('btn-success');
            wsStatusAlert.textContent = 'Connected';
            commandInput.disabled = false;
            sendButton.disabled = false;
        } else {
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.className = 'badge bg-danger me-2';
            wsStatusText.textContent = 'Connect Terminal';
            wsControl.classList.remove('btn-success');
            wsControl.classList.add('btn-danger');
            wsStatusAlert.textContent = 'Disconnected';
            commandInput.disabled = true;
            sendButton.disabled = true;
        }
    }

    function updatePrompt() {
        dirPrompt.textContent = getPrompt() + '>';
    }

    function getPrompt() {
        return currentDir;
    }

    function formatPathForDisplay(path) {
        path = path.replace(/\//g, '\\');
        if (path.match(/^[a-zA-Z]:\\/)) {
            path = path[0].toUpperCase() + path.slice(1);
        }
        if (path.endsWith('\\') && path.length > 3) {
            path = path.slice(0, -1);
        }
        return path;
    }

    function sendCommand() {
        const command = commandInput.value.trim();
        if (command && !waitingForResponse && socket && socket.connected) {
            waitingForResponse = true;
            
            terminal.innerHTML += `<div style="color: #00ff00;">${getPrompt()}> ${command}</div>`;
            terminal.scrollTop = terminal.scrollHeight;
            
            socket.emit('command', {
                agent_id: '{{ agent.id }}',
                command: command,
                current_dir: currentDir
            });
            
            commandInput.value = '';
        }
    }

    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-2`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.container-fluid').prepend(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    // Initialize terminal
    terminal.innerHTML = `
        <div>Connected to agent: {{ agent.hostname }} ({{ agent.id }})</div>
        <div>OS: {{ agent.os }} | Privilege: {{ agent.privilege }}</div>
        <div>Initial directory: ${currentDir}</div>
        <div>Type commands below:</div>
        <div></div>
    `;

    // Event listeners
    sendButton.addEventListener('click', sendCommand);
    commandInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendCommand();
    });

    wsControl.addEventListener('click', function() {
        if (isConnected) {
            socket.disconnect();
            updateConnectionStatus(false);
        } else {
            connectWebSocket();
        }
    });
});
</script>
{% endblock %}