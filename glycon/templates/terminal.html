{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-5"> 
    <div class="d-flex justify-content-between align-items-center mb-5">
        <h2>
            <i class="fas fa-terminal me-2"></i>Terminal - {{ agent.hostname }}
            <span class="badge bg-{% if agent.status == 'online' %}success{% else %}danger{% endif %}">
                {{ agent.status|capitalize }}
            </span>
        </h2>
        <div>
            <button id="wsControl" class="btn btn-{% if agent.ws_connected %}success{% else %}danger{% endif %} me-2">
                <i class="fas fa-plug me-1"></i>
                <span id="wsStatusText">{% if agent.ws_connected %}Disconnect{% else %}Connect{% endif %} Terminal</span>
            </button>
            <a href="{{ base_url }}{{ url_for('agent_detail', agent_id=agent.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Agent
            </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <span>Remote Shell</span>
                <span>
                    <span class="badge bg-{% if agent.ws_connected %}success{% else %}danger{% endif %} me-2" id="connection-status">
                        {% if agent.ws_connected %}Connected{% else %}Disconnected{% endif %}
                    </span>
                    <span class="badge bg-dark">Agent ID: {{ agent.id|truncate(10) }}</span>
                </span>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="terminal" style="height: 500px; background-color: #1e1e1e; color: #f8f8f8; padding: 15px; overflow-y: auto; font-family: 'Courier New', monospace;"></div>
        </div>
        <div class="card-footer">
            <div class="input-group">
                <span class="input-group-text bg-dark text-white" id="dir-prompt" 
                      style="font-family: Consolas, monospace; min-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                    {% if agent.os.startswith('Windows') %}>{% else %}$ {% endif %}
                </span>
                <input type="text" class="form-control bg-dark text-white border-dark" 
                       id="command-input" placeholder="Enter command..." autocomplete="off" {% if not agent.ws_connected %}disabled{% endif %}
                       style="font-family: Consolas, monospace;">
                <button class="btn btn-primary" type="button" id="send-command" {% if not agent.ws_connected %}disabled{% endif %}>
                    <i class="fas fa-paper-plane me-1"></i>Send
                </button>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            WebSocket status: <span id="wsStatusAlert">{% if agent.ws_connected %}Connected{% else %}Disconnected{% endif %}</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const terminal = document.getElementById('terminal');
    const commandInput = document.getElementById('command-input');
    const sendButton = document.getElementById('send-command');
    const dirPrompt = document.getElementById('dir-prompt');
    const wsControl = document.getElementById('wsControl');
    const wsStatusText = document.getElementById('wsStatusText');
    const wsStatusAlert = document.getElementById('wsStatusAlert');
    const connectionStatus = document.getElementById('connection-status');
    
    let currentDir = '?'; // Will be updated when agent connects
    let socket = null;
    let isConnected = {{ 'true' if agent.ws_connected else 'false' }};
    let commandHistory = [];
    let historyIndex = -1;
    let waitingMessage = null;
    let keepAliveInterval = null;

    function cleanText(text) {
        if (typeof text !== 'string') return '';
        
        // First replace common encoding artifacts
        text = text.replace(/Ã¿/g, ' ')
                   .replace(/\x00/g, '')  // Remove null bytes
                   .replace(/[^\x20-\x7E\r\n\t]/g, ' '); // Replace non-printable chars
        
        // Fix directory listing formatting
        if (text.includes('Directory of')) {
            text = text.replace(/(\d{2}\.\d{2}\.\d{4})\s+(\d{2}:\d{2})/g, '$1 $2')
                      .replace(/(\d+)\s+File\(s\)\s+(\d+)\s+bytes/g, '$1 File(s) $2 bytes')
                      .replace(/(\d+)\s+Dir\(s\)\s+([\d\s]+)\s+bytes free/g, 
                               (match, dirs, bytes) => `${dirs} Dir(s) ${bytes.replace(/\s/g, ',')} bytes free`);
        }
        
        return text;
    }

    function normalizePath(path) {
        if (!path || typeof path !== 'string') return currentDir;
        
        if ('{{ agent.os }}'.toLowerCase().includes('windows')) {
            path = path.replace(/\//g, '\\');
            if (path.match(/^[a-z]:\\/i)) {
                path = path[0].toUpperCase() + path.substr(1);
            }
            if (path.endsWith('\\') && path.length > 3) {
                path = path.slice(0, -1);
            }
        } else {
            path = path.replace(/\\/g, '/');
            if (path.endsWith('/') && path.length > 1) {
                path = path.slice(0, -1);
            }
        }
        
        return path;
    }

    function initializeSocket() {
        if (socket) {
            socket.disconnect();
            socket = null;
        }

        socket = io('/terminal', {
            reconnectionAttempts: 0, // Unlimited reconnection attempts
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            transports: ['websocket'],
            autoConnect: false,
            query: {
                agent_id: '{{ agent.id }}'
            }
        });

        socket.on('connect', function() {
            console.log('[Terminal] Socket connected');
            updateConnectionStatus(true);
            socket.emit('join_terminal', { agent_id: '{{ agent.id }}' });
            socket.emit('get_current_dir', { agent_id: '{{ agent.id }}' });
            
            // Add waiting message if it doesn't exist
            if (!document.getElementById('waiting-message')) {
                const waitingDiv = document.createElement('div');
                waitingDiv.id = 'waiting-message';
                waitingDiv.style.color = '#ffff00';
                waitingDiv.style.fontFamily = 'Consolas, monospace';
                waitingDiv.textContent = 'Waiting for beacon connection...';
                terminal.appendChild(waitingDiv);
                terminal.scrollTop = terminal.scrollHeight;
            }

            // Start keep-alive ping every 25 seconds
            if (keepAliveInterval) clearInterval(keepAliveInterval);
            keepAliveInterval = setInterval(() => {
                if (socket && socket.connected) {
                    socket.emit('keep_alive', { agent_id: '{{ agent.id }}' });
                    console.log('[Terminal] Sent keep_alive ping');
                }
            }, 25000);
        });

        socket.on('reconnect', () => {
            console.log('[Terminal] Socket reconnected');
            socket.emit('join_terminal', { agent_id: '{{ agent.id }}' });
            socket.emit('get_current_dir', { agent_id: '{{ agent.id }}' });
        });

        socket.on('agent_connected', function(data) {
            console.log('[Terminal] Agent connected to WebSocket');
            updateConnectionStatus(true);
            const waitingMsg = document.getElementById('waiting-message');
            if (waitingMsg) {
                waitingMsg.remove();
            }
            // Request current directory after connection
            socket.emit('get_current_dir', { agent_id: '{{ agent.id }}' });
        });

        socket.on('disconnect', function() {
            console.log('[Terminal] Socket disconnected');
            updateConnectionStatus(false);
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
            }
        });

        socket.on('connect_error', function(error) {
            console.error('[Terminal] Connection error:', error);
            showAlert('Connection failed: ' + (error.message || 'Unknown error'), 'danger');
            updateConnectionStatus(false);
            if (waitingMessage) {
                waitingMessage.remove();
                waitingMessage = null;
            }
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
            }
        });

        socket.on('terminal_output', function(data) {
            if (data.current_dir) {
                currentDir = normalizePath(data.current_dir);
                updatePrompt();
            }
            
            if (data.command) {
                const commandDiv = document.createElement('div');
                commandDiv.style.color = '#00ff00';
                commandDiv.style.fontFamily = 'Consolas, monospace';
                commandDiv.textContent = `${getPrompt()} ${data.command}`;
                terminal.appendChild(commandDiv);
            }
            
            if (data.output) {
                const outputDiv = document.createElement('div');
                outputDiv.style.fontFamily = 'Consolas, monospace';
                outputDiv.style.whiteSpace = 'pre-wrap';
                outputDiv.style.color = '#ffffff';
                outputDiv.textContent = cleanText(data.output);
                terminal.appendChild(outputDiv);
            }
            
            if (data.error) {
                const errorDiv = document.createElement('div');
                errorDiv.style.color = '#ff0000';
                errorDiv.style.fontFamily = 'Consolas, monospace';
                errorDiv.style.whiteSpace = 'pre-wrap';
                errorDiv.textContent = cleanText(data.error);
                terminal.appendChild(errorDiv);
            }
            
            terminal.scrollTop = terminal.scrollHeight;
        });

        socket.on('current_dir', function(data) {
            if (data.current_dir) {
                currentDir = normalizePath(data.current_dir);
                updatePrompt();
                const initialDirElement = document.getElementById('initial-dir');
                if (initialDirElement) {
                    initialDirElement.textContent = `Initial directory: ${currentDir}`;
                }
            }
        });

        socket.on('ws_status', function(data) {
            if (data.status === 'success') {
                updateConnectionStatus(data.action === 'start');
                showAlert(`WebSocket ${data.action}ed successfully: ${data.message || ''}`, 'success');
            } else {
                showAlert(`WebSocket error: ${data.message || 'Unknown error'}`, 'danger');
            }
        });

        socket.on('status', function(data) {
            updateConnectionStatus(data.status === 'connected');
        });
    }

    function updateConnectionStatus(connected) {
        isConnected = connected;
        if (connected) {
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'badge bg-success me-2';
            wsStatusText.textContent = 'Disconnect Terminal';
            wsControl.classList.remove('btn-danger');
            wsControl.classList.add('btn-success');
            wsStatusAlert.textContent = 'Connected';
            commandInput.disabled = false;
            sendButton.disabled = false;
        } else {
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.className = 'badge bg-danger me-2';
            wsStatusText.textContent = 'Connect Terminal';
            wsControl.classList.remove('btn-success');
            wsControl.classList.add('btn-danger');
            wsStatusAlert.textContent = 'Disconnected';
            commandInput.disabled = true;
            sendButton.disabled = true;
        }
    }

    function updatePrompt() {
        dirPrompt.textContent = `${getPrompt()}${currentDir.includes('\\') ? '>' : '$'}`;
    }

    function getPrompt() {
        return currentDir === '?' ? '' : currentDir;
    }

    function sendCommand() {
        const command = commandInput.value.trim();
        if (command) {
            commandHistory.unshift(command);
            if (commandHistory.length > 50) {
                commandHistory.pop();
            }
            historyIndex = -1;
            
            const commandDiv = document.createElement('div');
            commandDiv.style.color = '#00ff00';
            commandDiv.style.fontFamily = 'Consolas, monospace';
            commandDiv.textContent = `${getPrompt()}${currentDir.includes('\\') ? '>' : '$'} ${command}`;
            terminal.appendChild(commandDiv);
            
            try {
                socket.emit('command', {
                    agent_id: '{{ agent.id }}',
                    command: command,
                    current_dir: currentDir
                });
            } catch (e) {
                const errorDiv = document.createElement('div');
                errorDiv.style.color = '#ff0000';
                errorDiv.style.fontFamily = 'Consolas, monospace';
                errorDiv.textContent = `Error sending command: ${e.message}`;
                terminal.appendChild(errorDiv);
            }
            
            commandInput.value = '';
            terminal.scrollTop = terminal.scrollHeight;
        }
    }

    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-2`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.container-fluid').prepend(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    // Initialize terminal
    terminal.innerHTML = `
        <div style="font-family: Consolas, monospace;">Connected to agent: {{ agent.hostname }} ({{ agent.id }})</div>
        <div style="font-family: Consolas, monospace;">OS: {{ agent.os }} | Privilege: {{ agent.privilege }}</div>
        <div id="initial-dir" style="font-family: Consolas, monospace;">Initial directory: ${currentDir}</div>
        <div style="font-family: Consolas, monospace;">Type commands below:</div>
        <div></div>
    `;

    // Initialize socket
    initializeSocket();

    // Event listeners
    sendButton.addEventListener('click', sendCommand);
    
    commandInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendCommand();
    });

    commandInput.addEventListener('keydown', function(e) {
        if (commandHistory.length > 0) {
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    commandInput.value = commandHistory[historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    commandInput.value = commandHistory[historyIndex];
                } else {
                    historyIndex = -1;
                    commandInput.value = '';
                }
            }
        }
    });

    wsControl.addEventListener('click', function() {
        if (isConnected) {
            socket.emit('ws_control', {
                agent_id: '{{ agent.id }}',
                action: 'stop'
            });
        } else {
            // Clear terminal and show connection message
            terminal.innerHTML = `
                <div style="font-family: Consolas, monospace;">Connecting to agent: {{ agent.hostname }} ({{ agent.id }})</div>
                <div style="font-family: Consolas, monospace;">OS: {{ agent.os }} | Privilege: {{ agent.privilege }}</div>
                <div id="initial-dir" style="font-family: Consolas, monospace;">Initial directory: ?</div>
                <div></div>
            `;
            
            // Add waiting message
            waitingMessage = document.createElement('div');
            waitingMessage.id = 'waiting-message';
            waitingMessage.style.color = '#ffff00';
            waitingMessage.style.fontFamily = 'Consolas, monospace';
            waitingMessage.textContent = 'Waiting for beacon connection...';
            terminal.appendChild(waitingMessage);
            terminal.scrollTop = terminal.scrollHeight;

            fetch('/api/task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    agent_id: '{{ agent.id }}',
                    task_type: 'websocket',
                    task_data: {
                        action: 'start'
                    }
                })
            }).then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    socket.connect();
                } else {
                    if (waitingMessage) {
                        waitingMessage.remove();
                        waitingMessage = null;
                    }
                    showAlert('Failed to start WebSocket: ' + (data.message || 'Unknown error'), 'danger');
                }
            });
        }
    });

    if (isConnected) {
        socket.connect();
    }

    commandInput.focus();
});
</script>
{% endblock %}
