{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-5"> 
    <h2 class="mb-4"><i class="fas fa-camera me-2"></i>Screenshots</h2>

    <div class="row" id="screenshots-container">
        {% for screenshot in screenshots %}
        <div class="col-md-4 col-lg-3 mb-4 screenshot-card" data-screenshot-id="{{ screenshot.id }}">
            <div class="card shadow-sm h-100">
                <a href="{{ base_url }}{{ url_for('get_screenshot', screenshot_id=screenshot.id) }}" data-lightbox="screenshots">
                    <img src="{{ base_url }}{{ url_for('get_screenshot', screenshot_id=screenshot.id) }}" class="card-img-top" alt="Screenshot">
                </a>
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">
                        <a href="{{ base_url }}{{ url_for('agent_detail', agent_id=screenshot.agent_id) }}" class="text-decoration-none">
                            {{ screenshot.hostname }}
                        </a>
                    </h6>
                    <p class="card-text text-muted small">
                        <i class="far fa-clock me-1"></i>{{ screenshot.timestamp }}
                    </p>
                    <button class="btn btn-sm btn-outline-danger delete-screenshot" 
                            data-screenshot-id="{{ screenshot.id }}">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css">
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script>
// Initialize lightbox after ensuring jQuery is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize lightbox if available
    if (window.lightbox) {
        lightbox.option({
            'resizeDuration': 200,
            'wrapAround': true,
            'albumLabel': "Screenshot %1 of %2"
        });
    }

    // Connect to Socket.IO with error handling
    let socket;
    try {
        socket = io('/screenshots');
        console.log('Socket.IO connected successfully');
    } catch (e) {
        console.error('Socket.IO connection failed:', e);
        alert('Real-time features disabled. Please refresh the page.');
        return;
    }

    // Improved delete handler with event delegation
    document.getElementById('screenshots-container').addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.delete-screenshot');
        if (deleteBtn) {
            const screenshotId = deleteBtn.dataset.screenshotId;
            if (confirm('Are you sure you want to delete this screenshot?')) {
                deleteScreenshot(screenshotId, socket);
            }
        }
    });

    // Handle server responses
    socket.on('screenshot_deleted', function(data) {
        const card = document.querySelector(`[data-screenshot-id="${data.screenshot_id}"]`);
        if (card) {
            card.remove();
            showNotification('Screenshot deleted successfully', 'success');
        }
    });

    socket.on('screenshots_error', function(data) {
        console.error('Server error:', data.error);
        showNotification(data.error, 'error');
    });

    async function deleteScreenshot(id, socket) {
    try {
        // First try WebSocket
        if (socket && socket.connected) {
            socket.emit('delete_screenshot', { screenshot_id: id });
            return;
        }
        
        // Fallback to HTTP
        const response = await fetch(`/api/screenshots/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to delete screenshot');
        }
        
        // Manually remove the element if WebSocket didn't notify us
        const card = document.querySelector(`[data-screenshot-id="${id}"]`);
        if (card) {
            card.remove();
        }
        showNotification('Screenshot deleted successfully', 'success');
        
    } catch (error) {
        console.error('Delete failed:', error);
        showNotification('Delete failed: ' + error.message, 'error');
    }
}

    function showNotification(message, type) {
        // Simple notification - replace with your preferred UI
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} fixed-top mx-auto mt-3`;
        alert.style.width = '300px';
        alert.style.zIndex = '1000';
        alert.textContent = message;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    }
});
</script>
{% endblock %}